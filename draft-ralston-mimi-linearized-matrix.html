<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Linearized Matrix API</title>
<meta content="Travis Ralston" name="author">
<meta content="
       Matrix is an existing openly specified decentralized secure communications protocol
able to provide a framework for instant messaging interoperability. Matrix rooms
currently use a Directed Acyclic Graph (DAG) for persisting events/messages. Servers
broadcast their changes to the DAG to every other server in order to create new events. 
       This model provides excellent decentralization characteristics, however is complex
when aiming to adopt Matrix as an interoperable chat protocol, such as with the emergence
of the European Union's Digital Markets Act (DMA). 
       This document explores an API surface for Matrix which knowingly trades some of the
decentralization aspects for ease of interoperability at a per-room level. We call this
API surface &quot;Linearized Matrix&quot;. 
    " name="description">
<meta content="xml2rfc 3.17.0" name="generator">
<meta content="matrix" name="keyword">
<meta content="linearized" name="keyword">
<meta content="interoperability" name="keyword">
<meta content="messaging" name="keyword">
<meta content="mimi" name="keyword">
<meta content="draft-ralston-mimi-linearized-matrix-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.17.0
    Python 3.10.10
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.2
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.2
    MarkupSafe 2.1.1
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.28.1
    setuptools 65.6.0
    six 1.16.0
    wcwidth 0.2.6
-->
<link href="draft-ralston-mimi-linearized-matrix.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 8em !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Linearized Matrix API</td>
<td class="right">March 2023</td>
</tr></thead>
<tfoot><tr>
<td class="left">Ralston</td>
<td class="center">Expires 23 September 2023</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ralston-mimi-linearized-matrix-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2023-03-22" class="published">22 March 2023</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2023-09-23">23 September 2023</time></dd>
<dt class="label-authors">Author:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">T. Ralston</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Linearized Matrix API</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">Matrix is an existing openly specified decentralized secure communications protocol
able to provide a framework for instant messaging interoperability. Matrix rooms
currently use a Directed Acyclic Graph (DAG) for persisting events/messages. Servers
broadcast their changes to the DAG to every other server in order to create new events.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">This model provides excellent decentralization characteristics, however is complex
when aiming to adopt Matrix as an interoperable chat protocol, such as with the emergence
of the European Union's Digital Markets Act (DMA).<a href="#section-abstract-2" class="pilcrow">¶</a></p>
<p id="section-abstract-3">This document explores an API surface for Matrix which knowingly trades some of the
decentralization aspects for ease of interoperability at a per-room level. We call this
API surface "Linearized Matrix".<a href="#section-abstract-3" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://turt2live.github.io/ietf-mimi-linearized-matrix/draft-ralston-mimi-linearized-matrix.html">https://turt2live.github.io/ietf-mimi-linearized-matrix/draft-ralston-mimi-linearized-matrix.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ralston-mimi-linearized-matrix/">https://datatracker.ietf.org/doc/draft-ralston-mimi-linearized-matrix/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/turt2live/ietf-mimi-linearized-matrix">https://github.com/turt2live/ietf-mimi-linearized-matrix</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 23 September 2023.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2023 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1" class="keepWithNext"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-identifiers" class="internal xref">Identifiers</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-room-architecture" class="internal xref">Room Architecture</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-event-signing" class="internal xref">Event Signing</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-membership-api" class="internal xref">Membership API</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-state-events-api" class="internal xref">State Events API</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-room-events-api" class="internal xref">Room Events API</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-room-transfers" class="internal xref">Room Transfers</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-other-apis" class="internal xref">Other APIs</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-matrix-room-version" class="internal xref">Matrix Room Version</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-dag-compatible-event-struct" class="internal xref">DAG-Compatible Event Structure</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="auto internal xref">13</a>. <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="auto internal xref">14</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15" class="auto internal xref">15</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.1">
                <p id="section-toc.1-1.15.2.1.1"><a href="#section-15.1" class="auto internal xref">15.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.2">
                <p id="section-toc.1-1.15.2.2.1"><a href="#section-15.2" class="auto internal xref">15.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-address" class="internal xref">Author's Address</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">At a high level, rooms using Linearized Matrix have a single server which owns that room.
The owner can change, but will typically be the server which created the room. All other
servers are known as participating servers and call the owner server to send events. The
owner server is then responsible for informing all the other servers of any changes/messages
in the room.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Many aspects for how Matrix works as an interoperable messaging framework is described by
<span>[<a href="#I-D.ralston-mimi-matrix-framework" class="cite xref">I-D.ralston-mimi-matrix-framework</a>]</span>. This document replaces the eventual consistency model,
federation API, and DAG-related features of the framework document by presenting rooms as a
single, flat, array of events, without being incompatible with those same replaced components.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">This document does not currently define transport layer for the Linearized Matrix API, instead
focusing its efforts on the operational aspects of a room.<a href="#section-1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">This document additionally uses the following definitions:<a href="#section-2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-2.1">Owner Server: The server responsible for holding the room history, accepting new events, etc.<a href="#section-2-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.2">Participant Server: Every other server. Note that a server may inherit this role even if not
(currently) participating in the room.<a href="#section-2-2.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-2-3"><strong>TODO</strong>: Merge/add definitions from framework to here, such as "homeserver", "user", etc.<a href="#section-2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="identifiers">
<section id="section-3">
      <h2 id="name-identifiers">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-identifiers" class="section-name selfRef">Identifiers</a>
      </h2>
<p id="section-3-1"><strong>TODO</strong>: Expand upon this section.<a href="#section-3-1" class="pilcrow">¶</a></p>
<p id="section-3-2">A room ID has the format <code>!localpart:domain</code>, where the localpart is an opaque string and the domain
provides global uniqueness. The domain does not indicate that the room exists on that server, just
that it was originally created there.<a href="#section-3-2" class="pilcrow">¶</a></p>
<p id="section-3-3">A user ID has the format <code>@localpart:domain</code>, where the localpart is again an opaque string and
the domain is where the user was created (the server owns the user account).<a href="#section-3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="room-architecture">
<section id="section-4">
      <h2 id="name-room-architecture">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-room-architecture" class="section-name selfRef">Room Architecture</a>
      </h2>
<p id="section-4-1">As mentioned, rooms over Linearized Matrix have a concept of an "owning server". Typically the
room owner will be the server which created the room, however ownership can shift as needed. The
room owner is responsible for applying the room version semantics/access controls and distributing
the changes to other applicable servers (called participant servers).<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">At an implementation level, it should be possible for an owning server to use a DAG if it so
wishes, however for the protocol considerations a room has a single flat array to store state
changes and room events.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">Room state is the same as non-Linearized Matrix: represented by an event type and state key in
tuple form. "Current state" is simply the most recent instance of each event type and state key
pair in the array.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">To send an event into the room, each "participant server" (non-owner) asks the owner to send it
to the room. The owner adds the event to the room's array, after simple validation, and sends it
out to all participating servers (including the original sender, for simplicity of implementation).
If the owner would like to send an event, it simply adds the event to the array (assuming such an
action is valid) and broadcasts it.<a href="#section-4-4" class="pilcrow">¶</a></p>
<p id="section-4-5">Each room additionally records which Matrix room version it is using for access control behaviours,
such as Authorization Rules <span>[<a href="#MxV10AuthRules" class="cite xref">MxV10AuthRules</a>]</span>. This is required for when rooms gain a DAG-compatible
server in them. Note that this document introduces new semantics for a room version to be built
around, which would become the first elligible room version for a room using Linearized Matrix.<a href="#section-4-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="event-signing">
<section id="section-5">
      <h2 id="name-event-signing">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-event-signing" class="section-name selfRef">Event Signing</a>
      </h2>
<p id="section-5-1">Events are signed by the participant/original server to ensure the owning server is not spoofing
events on behalf of another server. The exact details for how a server's signing keys are shared
to other servers is left as a transport consideration, however signing keys are currently expected
to be ed25519 keys.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">In the existing Matrix Federation APIs, a PDU <span>[<a href="#MxV10PDUFormat" class="cite xref">MxV10PDUFormat</a>]</span> contains an event and has several
DAG-specific fields to it. When using the Linearized Matrix API, we introduce a concept of a <em>Linear
PDU</em> which looks similar to a regular room event, but has all non-essential fields removed.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3"><code>jsonc
{
  "room_id": "!room:example.org", // the room ID the event is sent within
  "type": "org.example.event_type", // the implied (or explicit) event type
  "state_key": "", // for state events, even if an empty string
  "sender": "@user:example.org", // the user ID of the sender
  "origin_server_ts": 123456789, // milliseconds since epoch
  "authorized_sending_server": "owner.example.org", // the domain of the room owner
  "content": {
    // the normal event content
  },
  "hashes": {
    "sha256": "&lt;content hash, just like in Matrix today&gt;"
  }
}
</code><a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4"><span>[<a href="#MxContentHashCalculation" class="cite xref">MxContentHashCalculation</a>]</span><a href="#section-5-4" class="pilcrow">¶</a></p>
<p id="section-5-5">The Linear PDU is then redacted <span>[<a href="#MxRedaction" class="cite xref">MxRedaction</a>]</span>, canonicalized <span>[<a href="#MxCanonicalJSON" class="cite xref">MxCanonicalJSON</a>]</span>, and signed
<span>[<a href="#MxSigning" class="cite xref">MxSigning</a>]</span>. The signature is supplied to the owner server alongside the event itself for sending
to the room.<a href="#section-5-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="membership-api">
<section id="section-6">
      <h2 id="name-membership-api">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-membership-api" class="section-name selfRef">Membership API</a>
      </h2>
<p id="section-6-1">After a room is created (by an imagined <code>/createRoom</code> API, for example), it will exist on a single
server: the owner's. This is not particularly helpful if the goal is to talk to other people, so a
way to involve others in the conversation is needed.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">Matrix currently has membership states for join, leave, invite, kick, ban, and knock (request invite).
These states have their own set of rules governed by the room version to prevent cases of, for example,
ban evasion.<a href="#section-6-2" class="pilcrow">¶</a></p>
<p id="section-6-3"><strong>TODO</strong>: Describe those membership transitions. Currently specified in the Client-Server API
https://spec.matrix.org/v1.6/client-server-api/#room-membership (we should move that).<a href="#section-6-3" class="pilcrow">¶</a></p>
<p id="section-6-4">A transport layer would describe a formal request/response structure for the membership APIs. Those
requests should be able to be rejected by the owner server prior to the membership transition happening
in the room, as the owner server may wish to apply additional checks for anti-abuse or similar.<a href="#section-6-4" class="pilcrow">¶</a></p>
<p id="section-6-5">Additionally, for invites specifically, the owner server MUST proxy an invite to the targeted
participant server before responding to the original invite request, if it has not already rejected
the request itself. This is to ensure the participant server has an opportunity to decline the
invite request for its own reasons, such as its own anti-abuse measures.<a href="#section-6-5" class="pilcrow">¶</a></p>
<p id="section-6-6">The owner server broadcasts successful membership changes as <code>m.room.member</code> events to all participant
servers in the room, including the sending server.<a href="#section-6-6" class="pilcrow">¶</a></p>
<p id="section-6-7">A server is considered to be "in the room" if it has at least one user with <code>join</code> membership state.<a href="#section-6-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="state-events-api">
<section id="section-7">
      <h2 id="name-state-events-api">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-state-events-api" class="section-name selfRef">State Events API</a>
      </h2>
<p id="section-7-1">Matrix, and therefore Linearized Matrix, tracks changes to the room as <em>state events</em>. State events
have an event type and state key to differentiate them from room (or non-state) events. While history
for state changes is stored in the room, only the most recent change for an event type and state key
pair is considered "current state". For example, the current room name is the most recent <code>m.room.name</code>
state event.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">As already mentioned in this document, a transport layer would be responsible for the request/response
structure for this API, however a need would be present to send (arbitrary) state events, read those
state events back, and read the whole of current state (including membership).<a href="#section-7-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="room-events-api">
<section id="section-8">
      <h2 id="name-room-events-api">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-room-events-api" class="section-name selfRef">Room Events API</a>
      </h2>
<p id="section-8-1">Room events include messages and redactions, as well as messaging features like reactions, edits, etc.
These may be encrypted in supported rooms (ones which specify an encryption algorithm in their room state),
and in their unencrypted form will use the Matrix concept of Extensible Events.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2"><strong>TODO</strong>: Update the message format I-D for MSC1767 extensible events and link it here.
https://github.com/matrix-org/matrix-spec-proposals/blob/main/proposals/1767-extensible-events.md<a href="#section-8-2" class="pilcrow">¶</a></p>
<p id="section-8-3">A transport layer would specify request/response structures for sending, receiving, reading, and
discovering nearby events (for scrollback purposes).<a href="#section-8-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="room-transfers">
<section id="section-9">
      <h2 id="name-room-transfers">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-room-transfers" class="section-name selfRef">Room Transfers</a>
      </h2>
<p id="section-9-1">The current room owner would be stored as a state event within the room, defaulting to the room creator.
To transfer ownership, the current owner chooses a participant server and requests that it accept the
ownership role. If the participant server agrees to take ownership, it would create and sign a new room
ownership state event. The current owner then signs the ownership state event itself and sends it to all
participating servers (including the new owner), just as it would for any other event. All requests from
that point forward now go to the new owner, and the old owner becomes a regular participating server.<a href="#section-9-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="other-apis">
<section id="section-10">
      <h2 id="name-other-apis">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-other-apis" class="section-name selfRef">Other APIs</a>
      </h2>
<p id="section-10-1"><strong>TODO</strong>: Expand upon this section.<a href="#section-10-1" class="pilcrow">¶</a></p>
<p id="section-10-2">A transport layer would specify request/response structures for:<a href="#section-10-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-3.1">Media/attachment distribution<a href="#section-10-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-10-3.2">APIs to support end-to-end encryption<a href="#section-10-3.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-10-3.3">Ephemeral data such as receipts, typing notifications, and presence<a href="#section-10-3.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-10-3.4">Resolving an identifer to a room ID<a href="#section-10-3.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-10-3.5">User profiles (display names and avatars)<a href="#section-10-3.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-10-3.6">Other APIs as required to support interoperable messaging<a href="#section-10-3.6" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="matrix-room-version">
<section id="section-11">
      <h2 id="name-matrix-room-version">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-matrix-room-version" class="section-name selfRef">Matrix Room Version</a>
      </h2>
<p id="section-11-1">The first room version which supports Linearized Matrix will base its requirements on Matrix's existing
Room Version 10 definition <span>[<a href="#MxRoomVersion10" class="cite xref">MxRoomVersion10</a>]</span>. Changes will be made to support the following features:<a href="#section-11-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-11-2.1">A description of the authorization rules when not using a DAG.<a href="#section-11-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-2.2">The DAG-compatible signing structure for events.<a href="#section-11-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-2.3">The use of Matrix's Extensible Events content format.<a href="#section-11-2.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-11-3"><strong>TODO</strong>: Expand upon this section with formal details of what the above looks like for a room version.<a href="#section-11-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="dag-compatible-event-structure">
<section id="section-12">
      <h2 id="name-dag-compatible-event-struct">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-dag-compatible-event-struct" class="section-name selfRef">DAG-Compatible Event Structure</a>
      </h2>
<p id="section-12-1">Linearized Matrix is simply a simpler API for accessing a room on Matrix, which means servers which support
a full-blown DAG can still join and participate in the room. With DAG-compatible servers in the room, the
DAG-compatible servers talk to each other directly as they do with the current Matrix APIs, only involving
the room owner for state changes (like membership).<a href="#section-12-1" class="pilcrow">¶</a></p>
<p id="section-12-2">Normally, events are checked for signatures from the "origin" server implied by the <code>sender</code> on an event.
Events sent with the Linearized Matrix API are already signed by the participant server to ensure the owner
server isn't spoofing them, however an owner server might not always be DAG-compatible itself. To remedy this,
owner servers can delegate their DAG involvement to a DAG-compatible server in the room.<a href="#section-12-2" class="pilcrow">¶</a></p>
<p id="section-12-3">Delegating to a DAG-compatible server means creating a <em>Delegated Linear PDU</em> from a <em>Linear PDU</em>. The owner
moves the <code>authorized_sending_server</code> value (which should be itself) to <code>original_authorized_sending_server</code>
then populates <code>authorized_sending_server</code> with the domain name for the DAG-compatible server it is using.
The owner server then signs the Delegated Linear PDU and sends it to the DAG-compatible server, which then
appends all the DAG-specific fields and signs the resulting PDU itself before sending it to all the other
DAG-compatible servers in the room.<a href="#section-12-3" class="pilcrow">¶</a></p>
<p id="section-12-4">Note that while a Delegated Linear PDU modifies the structure that was signed as a Linear PDU, it is easily
possible to reconstruct a Linear PDU from a Delegated Linear PDU. Similarly, a DAG-ready PDU can be redacted
down to a Delegated Linear PDU with ease.<a href="#section-12-4" class="pilcrow">¶</a></p>
<p id="section-12-5">A complete DAG-ready PDU would look like:<a href="#section-12-5" class="pilcrow">¶</a></p>
<p id="section-12-6"><code>jsonc
{
  "room_id": "!room:example.org", // the room ID the event is sent within
  "type": "org.example.event_type", // the implied (or explicit) event type
  "state_key": "", // for state events, even if an empty string
  "sender": "@user:example.org", // the user ID of the sender
  "origin_server_ts": 123456789,
  "original_authorized_sending_server": "owner.example.org", // the domain of the room owner
  "authorized_sending_server": "dag.example.org", // DAG-capable server; see bridging considerations for selection approach
  "content": {
    // the normal event content
  },
  "hashes": {
    "sha256": "&lt;content hash, just like in Matrix today&gt;"
  },
  // other event format stuff:
  "auth_events": ["$event1", "$event2", "$etc"],
  "depth": 42,
  "prev_events": ["$event3", "$event4", "$etc2"],
  "signatures": {
    "dag.example.org": {
      "ed25519:abc": "&lt;signature for PDU&gt;"
    },
    "owner.example.org": {
      "ed25519:def": "&lt;signature for Delegated Linear PDU&gt;"
    },
    "example.org": {
      "ed25519:ghi": "&lt;signature for non-delegated Linear PDU&gt;"
    }
  }
}
</code><a href="#section-12-6" class="pilcrow">¶</a></p>
<p id="section-12-7">When validating the signatures <span>[<a href="#MxSignatureValidation" class="cite xref">MxSignatureValidation</a>]</span> on this PDU, DAG-capable servers would apply the
following algorithm. If at any point the check fails, the algorithm bails.<a href="#section-12-7" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12-8">
<li id="section-12-8.1">If an <code>original_authorized_sending_server</code> is present, construct the implied Linear PDU from the PDU and
validate the signature for the server implied by the <code>sender</code>. Additionally, redact the PDU down to a
Delegated Linear PDU and validate the signature for the <code>authorized_sending_server</code> value.<a href="#section-12-8.1" class="pilcrow">¶</a>
</li>
        <li id="section-12-8.2">If an <code>original_authorized_sending_server</code> is NOT present, redact the PDU down to a Linear PDU and validate
the signature for the <code>authorized_sending_server</code> value.<a href="#section-12-8.2" class="pilcrow">¶</a>
</li>
        <li id="section-12-8.3">Without considering the signatures from the domains in previous steps, verify the signatures per normal.
Note that the step where the signature for the "origin server" (defined as the one implied by the PDU's
<code>sender</code>) is implicitly checked as part of step 1 and 2, and not actually possible to verify in the
traditional sense. That particular step in event validation is therefore skipped when step 1 or 2 is
performed.<a href="#section-12-8.3" class="pilcrow">¶</a>
</li>
      </ol>
</section>
</div>
<div id="security-considerations">
<section id="section-13">
      <h2 id="name-security-considerations">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-13-1"><strong>TODO</strong>: Expand upon this section.<a href="#section-13-1" class="pilcrow">¶</a></p>
<p id="section-13-2">As discussed in the Event Signing section, we ensure servers are not able to spoof events.<a href="#section-13-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-14">
      <h2 id="name-iana-considerations">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-14-1">This document has no IANA actions.<a href="#section-14-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-15">
      <h2 id="name-references">
<a href="#section-15" class="section-number selfRef">15. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-15.1">
        <h3 id="name-normative-references">
<a href="#section-15.1" class="section-number selfRef">15.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ralston-mimi-matrix-framework">[I-D.ralston-mimi-matrix-framework]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span>, <span class="refTitle">"Matrix as a Messaging Framework"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-matrix-framework-01</span>, <time datetime="2023-03-13" class="refDate">13 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-matrix-framework-01">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-matrix-framework-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
      <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-15.2">
        <h3 id="name-informative-references">
<a href="#section-15.2" class="section-number selfRef">15.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="MxCanonicalJSON">[MxCanonicalJSON]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Appendices | Canonical JSON"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/appendices/#canonical-json">https://spec.matrix.org/v1.6/appendices/#canonical-json</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxContentHashCalculation">[MxContentHashCalculation]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Federation API | Calculating the Content Hash"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/server-server-api/#calculating-the-content-hash-for-an-event">https://spec.matrix.org/v1.6/server-server-api/#calculating-the-content-hash-for-an-event</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxRedaction">[MxRedaction]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Client-Server API | Redaction Algorithm"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/client-server-api/#redactions">https://spec.matrix.org/v1.6/client-server-api/#redactions</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxRoomVersion10">[MxRoomVersion10]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Room Version 10"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/rooms/v10">https://spec.matrix.org/v1.6/rooms/v10</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxSignatureValidation">[MxSignatureValidation]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Federation API | Validating Hashes and Signatures"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/server-server-api/#validating-hashes-and-signatures-on-received-events">https://spec.matrix.org/v1.6/server-server-api/#validating-hashes-and-signatures-on-received-events</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxSigning">[MxSigning]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Appendices | Signing"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/appendices/#signing-details">https://spec.matrix.org/v1.6/appendices/#signing-details</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxV10AuthRules">[MxV10AuthRules]</dt>
        <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Room Version 10 | Authorization Rules"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/rooms/v10/#authorization-rules">https://spec.matrix.org/v1.6/rooms/v10/#authorization-rules</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MxV10PDUFormat">[MxV10PDUFormat]</dt>
      <dd>
<span class="refAuthor">The Matrix.org Foundation C.I.C.</span>, <span class="refTitle">"Matrix Specification | v1.6 | Room Version 10 | Event Format"</span>, <time datetime="2023" class="refDate">2023</time>, <span>&lt;<a href="https://spec.matrix.org/v1.6/rooms/v10/#event-format-1">https://spec.matrix.org/v1.6/rooms/v10/#event-format-1</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">Thank you to the Matrix Spec Core Team (SCT), and in particular Richard van der Hoff, for
exploring how Matrix rooms could be represented as a linear structure, leading to this document.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-address">
<a href="#name-authors-address" class="section-name selfRef">Author's Address</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
